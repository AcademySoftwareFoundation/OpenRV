#!/bin/sh

#
# This script attempts to register RV as the protocol hander for
# links that look like rvlink://blah.
#
# It should be sufficient for gnome apps like pidgin and kde apps
# like konqueror.  Firefox seems to pay attention to the gnome
# settings at least to the degree that it recognizes links of the
# form rvlink://blah as hot-links, but it may still ask you to
# select the application the first time you click on one.
#
# We (tweak) are not expert on this stuff, so if you have ideas
# about how to do this better or more completely, please let us
# know !  (support@tweakadmin.com)
#

if [ -z "$RV_HOME" ]; then
    canonicalName=$(readlink -f "$0")
    binName=$(dirname "$canonicalName")
    homeName=$(dirname "$binName")
    export RV_HOME="$homeName"
fi

export rv="$RV_HOME/bin/rv"

echo "Installing rvlink protocol handler for Gnome."

if which gconftool-2; then
    gconftool-2 --set --type=string /desktop/gnome/url-handlers/rvlink/command $rv' "%s"'
    gconftool-2 --set --type=bool /desktop/gnome/url-handlers/rvlink/enabled true
    gconftool-2 --set --type=bool /desktop/gnome/url-handlers/rvlink/need-terminal false
else
    echo "WARNING: gconftool-2 not found: skipping gnome url-handler registration."
fi

# If you want to install this system wide copy the rvlink.protocol file to /usr/share/kde4/services/
echo "Installing rvlink protocol handler for KDE."

kdeProtoDir="$HOME/.kde/share/services"
if [ -e "$HOME/.kde4/share/services" ]; then
    kdeProtoDir="$HOME/.kde4/share/services"
fi
if [ -n "$KDEDIR" ]; then
    kdeProtoDir="$KDEDIR/share/services"
fi

if [ ! -e "$kdeProtoDir" ]; then
    mkdir -p "$kdeProtoDir"
fi

if [ -e "$kdeProtoDir" ]; then
    kdeProtoFile="$kdeProtoDir/rvlink.protocol"
    rm -f "$kdeProtoFile"
    cat > "$kdeProtoFile" << EOF
[Protocol]
exec=$rv "%u"
protocol=rvlink
input=none
output=none
helper=true
listing=false
reading=false
writing=false
makedir=false
deleting=false
EOF
    echo "Successfully created $kdeProtoFile"
else
    echo "WARNING: Can't find or create KDE protocol directory: $kdeProtoDir. Skipping KDE url-handler registration."
fi

# If you want to install this system wide run the desktop-file-install as sudo/root
# and remove the --dir= bit.
echo "Installing rvlink protocol handler for XDG"

if which desktop-file-install; then
    xdgDir=$HOME/.local/share/applications
    if [ ! -e "$xdgDir" ]; then
        mkdir -p "$xdgDir"
    fi

    if [ ! -e "$xdgDir" ]; then
        xdgFile="$xdgDir/rv.desktop"
        rm -f "$xdgFile"
        cat > "$xdgFile" << EOF
[Desktop Entry]
Name=RVLink
Type=Application
Exec=$rv %U
Terminal=false
Categories=AudioVideo;Viewer;Player;
MimeType=x-scheme-handler/rvlink;
NoDisplay=true
EOF
        echo "Successfully created $xdgFile"
    else
        echo "WARNING: Can't find or create XDG directory: $xdgDir. Skipping XDG url-handler registration."
    fi

    desktop-file-install "$xdgFile" --rebuild-mime-info-cache --dir="$xdgDir"
else
    echo "WARNING: desktop-file-install not found: Skipping xdg-handler registration."
fi

echo "Done."
