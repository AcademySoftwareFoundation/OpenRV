#
# Copyright (C) 2022  Autodesk, Inc. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

CMAKE_MINIMUM_REQUIRED(VERSION 3.24)

PROJECT("mio_ffmpeg")

SET(_target
    "mio_ffmpeg"
)

LIST(APPEND _sources init.cpp)

SET(CMAKE_CXX_STANDARD
    17
)
SET(CMAKE_C_STANDARD
    17
)
SET(CMAKE_CXX_EXTENSIONS
    OFF
)
SET(CMAKE_CXX_STANDARD_REQUIRED
    TRUE
)
SET(CMAKE_C_STANDARD_REQUIRED
    TRUE
)

IF(APPLE)
  SET(CMAKE_OSX_ARCHITECTURES
      "x86_64"
      CACHE STRING "Force compilation for Intel processors." FORCE
  )
ENDIF()

ADD_LIBRARY(
  ${_target} SHARED
  ${_sources}
)

# TODO_IBR: Gather compiler flags for Win and Linux.
IF(APPLE)
  TARGET_COMPILE_OPTIONS(
    ${_target}
    PRIVATE -DARCH_IA32_64
            -DPLATFORM_DARWIN
            -DTWK_LITTLE_ENDIAN
            -D__LITTLE_ENDIAN__
            -DPLATFORM_APPLE_MACH_BSD
            -DPLATFORM_OPENGL
            -DGL_SILENCE_DEPRECATION
            # _XOPEN_SOURCE, Required on macOS to resolve such compiling error:
            # /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX12.3.sdk/usr/include/ucontext.h:51:2: error: The
            # deprecated ucontext routines require _XOPEN_SOURCE to be defined error The deprecated ucontext routines require _XOPEN_SOURCE to be defined
            # https://pubs.opengroup.org/onlinepubs/009695399/
            -D_XOPEN_SOURCE=600
            -D_DARWIN_C_SOURCE # at least on MacOS: needed in Twk for strcasecmp which is not standard
            -DOSX_VERSION=${_macos_version_string}
  )
ENDIF()

SET(RV_INST_LIB_DIR
    "../../lib"
)

SET(MIO_FFMPEG_LIB_DIR
    "lib"
)

SET(MOVIE_FFMPEG_NAME
    ${CMAKE_STATIC_LIBRARY_PREFIX}MovieFFMpeg${CMAKE_STATIC_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_MOVIEFFMPEG ${MOVIE_FFMPEG_NAME}
  HINTS ${MIO_FFMPEG_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY FFMPEG: ${LIB_MOVIEFFMPEG} -- Name: ${MOVIE_FFMPEG_NAME}")
SET(BOOST_PGRAM_OPTIONS_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}boost_program_options${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_BOOST_PGRAMOPTIONS ${BOOST_PGRAM_OPTIONS_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY BOOST PGRAM OPTS: ${LIB_BOOST_PGRAMOPTIONS} -- Name: ${LIB_BOOST_PGRAMOPTIONS}")
SET(BOOST_FS_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}boost_file_system${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_BOOST_FILESYSTEM ${BOOST_FS_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY BOOST FS: ${LIB_BOOST_FILESYSTEM}")
SET(TWK_FB_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}TwkFB${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_TWK_FB ${CMAKE_SHARED_LIBRARY_PREFIX}TwkFB${CMAKE_SHARED_LIBRARY_SUFFIX}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY TWK FB: ${LIB_TWK_FB} -- Name: ${TWK_FB_NAME}")

# ----------------
# Dependencies of Deps
# ----------------

SET(MOVIE_FFMPEG_MP4V2_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}mp4v2${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_MP4V2 ${MOVIE_FFMPEG_MP4V2_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY MP4V2: ${LIB_MP4V2} -- Name: ${MOVIE_FFMPEG_MP4V2_NAME}")

SET(MOVIE_FFMPEG_MP4V2Utils_NAME
    ${CMAKE_STATIC_LIBRARY_PREFIX}mp4v2Utils${CMAKE_STATIC_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_MP4V2Utils ${MOVIE_FFMPEG_MP4V2Utils_NAME}
  HINTS ${MIO_FFMPEG_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY MP4VS2Utils: ${LIB_MP4V2Utils} -- Name: ${MOVIE_FFMPEG_MP4V2Utils_NAME}")

# FFMpeg Deps (AV & ffmpeg)
SET(FFMPEG_AVCODEC_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}avcodec.58.134.100${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_FFMPEG_AVCODEC ${FFMPEG_AVCODEC_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY AVCODEC: ${LIB_FFMPEG_AVCODEC} -- Name: ${FFMPEG_AVCODEC_NAME}")

SET(FFMPEG_AVFORMAT_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}avformat.58.76.100${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_FFMPEG_AVFORMAT ${FFMPEG_AVFORMAT_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY AVFORMAT: ${LIB_FFMPEG_AVFORMAT} -- Name: ${FFMPEG_AVFORMAT_NAME}")

SET(FFMPEG_AVUTIL_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}avutil.56.70.100${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_FFMPEG_AVUTIL ${FFMPEG_AVUTIL_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY AVUTIL: ${LIB_FFMPEG_AVUTIL} -- Name: ${FFMPEG_AVUTIL_NAME}")

SET(MOVIE_FFMPEG_SWRESAMPLE_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}swresample.3.9.100${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_FFMPEG_SWRESAMPLE ${MOVIE_FFMPEG_SWRESAMPLE_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY FFMPEG_SWRESAMPLE: ${LIB_FFMPEG_SWRESAMPLE} -- Name: ${MOVIE_FFMPEG_SWRESAMPLE_NAME}")

SET(MOVIE_FFMPEG_SWSCALE_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}swscale.5.9.100${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_FFMPEG_SWSCALE ${MOVIE_FFMPEG_SWSCALE_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY FFMPEG_SWSCALE: ${LIB_FFMPEG_SWSCALE} -- Name: ${MOVIE_FFMPEG_SWSCALE_NAME}")

# Twk Deps
SET(TWEAK_TwkAudio_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}TwkAudio${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_Tweak_TwkAudio ${TWEAK_TwkAudio_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY Tweak TwkAudio: ${LIB_Tweak_TwkAudio} -- Name: ${TWEAK_TwkAudio_NAME}")

SET(TWEAK_TwkExc_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}TwkExc${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_Tweak_TwkExc ${TWEAK_TwkExc_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY Tweak TwkExc: ${LIB_Tweak_TwkExc} -- Name: ${TWEAK_TwkExc_NAME}")

SET(TWEAK_TwkMovie_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}TwkMovie${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_Tweak_TwkMovie ${TWEAK_TwkMovie_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY Tweak TwkMovie: ${LIB_Tweak_TwkMovie} -- Name: ${TWEAK_TwkMovie_NAME}")

SET(TWEAK_TwkUtils_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}TwkUtil${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_Tweak_TwkUtil ${TWEAK_TwkUtils_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY Tweak TwkUtil: ${LIB_Tweak_TwkUtil} -- Name: ${TWEAK_TwkUtils_NAME}")

# Boost Dep
SET(BOOST_FS_NAME
    ${CMAKE_SHARED_LIBRARY_PREFIX}boost_filesystem${CMAKE_SHARED_LIBRARY_SUFFIX}
)
FIND_LIBRARY(
  LIB_BOOST_FS ${BOOST_FS_NAME}
  HINTS ${RV_INST_LIB_DIR}
  NO_DEFAULT_PATH
)
MESSAGE("DEP LIBRARY BOOST FS: ${LIB_BOOST_FS} -- Name: ${BOOST_FS_NAME}")

TARGET_INCLUDE_DIRECTORIES(
  ${_target}
  PRIVATE "includes" "includes/Imath"
)

IF(RV_TARGET_WINDOWS)
  TARGET_COMPILE_OPTIONS(
    ${_target}
    PRIVATE "-D__STDC_CONSTANT_MACROS"
  )
ENDIF()

TARGET_LINK_LIBRARIES(
  ${_target}
  PRIVATE ${LIB_MOVIEFFMPEG} ${LIB_BOOST_PGRAMOPTIONS} ${LIB_TWK_FB}
  PRIVATE ${LIB_FFMPEG_AVCODEC} ${LIB_FFMPEG_AVFORMAT} ${LIB_FFMPEG_AVUTIL} ${LIB_FFMPEG_SWRESAMPLE} ${LIB_FFMPEG_SWSCALE}
  PRIVATE ${LIB_MP4V2} ${LIB_MP4V2Utils}
  PRIVATE ${LIB_BOOST_FS}
  PRIVATE ${LIB_Tweak_TwkAudio} ${LIB_Tweak_TwkExc} ${LIB_Tweak_TwkMovie} ${LIB_Tweak_TwkUtil}
)
