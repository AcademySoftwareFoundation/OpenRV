#!/bin/sh

#
# Copyright (C) 2022  Autodesk, Inc. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

#
# This script sets the APP_HOME environment (if not already set),
# makes sure the plugins are the path and launches the actual binary.
#
# NOTE: doesn't properly set APP_HOME if invoked from a link to the script
# and APP_HOME is not already set
#

set -o noglob

# Uncomment this if you're on an older linux distro and RV is hanging in
# the Audio preferences or on startup with audio sources
# export PA_ALSA_EXCLUDE_DMIX_DEFAULT=1

# For unknown reasons, LANG causes problems when set to
# interesting values (like fr_FR.UTF-8).
unset LANG

name=$(basename "$0")

if [ -z "$RV_HOME" ]; then
    canonicalName=$(readlink -f "$0")
    binName=$(dirname "$canonicalName")
    homeName=$(dirname "$binName")
    export RV_HOME="$homeName"
fi

echo "RV_HOME=$RV_HOME"
platform=i386
bin="$RV_HOME/bin/$name.bin.$platform"

if [ ! -e "$bin" ]; then
    bin="$RV_HOME/bin/$name.bin"
fi

if [ ! -e "$bin" ]; then
    echo "ERROR: binary $bin not found"
    exit 1
fi

unset BUILD_ROOT
export PATH="$RV_HOME/bin:$PATH"

if [ -n "$LD_LIBRARY_PATH" ]; then
     export LD_LIBRARY_PATH="$RV_HOME/lib:$LD_LIBRARY_PATH"
else
     export LD_LIBRARY_PATH="$RV_HOME/lib"
fi

# Detect if VFX2023 (OpenSSL 1.1.1) or VFX2024+ (OpenSSL (3+).
set python_version = `$RV_HOME/bin/python -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")'`
set minor_version = `echo $python_version | cut -d. -f2`

set is_python_vfx2023 = 0 # VFX2023 Python 3.10
set is_python_vfx2024 = 0 # VFX2024 Python 3.11

if ($minor_version > 10) then
    set is_python_vfx2024 = 1
else
    set is_python_vfx2023 = 1
endif

# Unless the RV_USE_SYSTEM_OPENSSL environment variable is set, use the
# OpenSSL provided with RV when the required OpenSSL version cannot be found.
<<<<<<< HEAD
# 
if (! $?RV_USE_SYSTEM_OPENSSL) then
    set required_openssl_found = ""
    if ($is_python_vfx2023) then
        set required_openssl_found = "`openssl version | grep 1.1.1`"
    endif

    if ( "$required_openssl_found" == "" ) then
        setenv LD_LIBRARY_PATH "$RV_HOME/lib/OpenSSL:$LD_LIBRARY_PATH"
    endif
endif
=======
if [ -z "$RV_USE_SYSTEM_OPENSSL" ]; then
     required_openssl_found=$(openssl version | grep 1.1.1)
     if [ -z "$required_openssl_found" ]; then
        export LD_LIBRARY_PATH "$RV_HOME/lib/OpenSSL:$LD_LIBRARY_PATH"
     fi
fi
>>>>>>> pr/rockylinux8

exec "$bin" "$@"
